<button
  mat-button
  [matMenuTriggerFor]="identityMenu"
  class="identity-switcher-button"
>
  <mat-icon>account_circle</mat-icon>
  <span class="identity-name">{{ getActiveDisplayName() }}</span>
  <mat-icon>arrow_drop_down</mat-icon>
</button>

<mat-menu #identityMenu="matMenu" class="identity-switcher-menu">
  <!-- User Section -->
  @if (users().length > 0) {
    <div class="menu-section">
      <div class="section-header">Personal</div>
      @for (user of users(); track user.id.value) {
        <button
          mat-menu-item
          (click)="selectUser(user.id.value, user.displayName)"
          [class.active]="
            activeOwner()?.ownerType === 'user' &&
            activeOwner()?.ownerId === user.id.value
          "
        >
          <mat-icon>person</mat-icon>
          <span>{{ user.displayName }}</span>
        </button>
      }
    </div>
  }

  <!-- Organizations Section -->
  @if (organizations().length > 0) {
    <mat-divider></mat-divider>
    <div class="menu-section">
      <div class="section-header">Organizations</div>
      @for (org of organizations(); track org.id.value) {
        <button
          mat-menu-item
          (click)="selectOrganization(org.id.value, org.name)"
          [class.active]="
            activeOwner()?.ownerType === 'organization' &&
            activeOwner()?.ownerId === org.id.value
          "
        >
          <mat-icon>business</mat-icon>
          <span>{{ org.name }}</span>
        </button>
      }
    </div>
  }

  <!-- Teams Section (shown when an organization is selected) -->
  @if (teams().length > 0) {
    <mat-divider></mat-divider>
    <div class="menu-section">
      <div class="section-header">Teams</div>
      @for (team of teams(); track team.id.value) {
        <button
          mat-menu-item
          (click)="selectTeam(team.id.value, team.name)"
          [class.active]="
            activeOwner()?.ownerType === 'team' &&
            activeOwner()?.ownerId === team.id.value
          "
          class="sub-item"
        >
          <mat-icon>groups</mat-icon>
          <span>{{ team.name }}</span>
        </button>
      }
    </div>
  }

  <!-- Partners Section (shown when an organization is selected) -->
  @if (partners().length > 0) {
    <mat-divider></mat-divider>
    <div class="menu-section">
      <div class="section-header">Partners</div>
      @for (partner of partners(); track partner.id.value) {
        <button
          mat-menu-item
          (click)="selectPartner(partner.id.value, partner.name)"
          [class.active]="
            activeOwner()?.ownerType === 'partner' &&
            activeOwner()?.ownerId === partner.id.value
          "
          class="sub-item"
        >
          <mat-icon>handshake</mat-icon>
          <span>{{ partner.name }}</span>
        </button>
      }
    </div>
  }

  @if (
    users().length === 0 &&
    organizations().length === 0 &&
    teams().length === 0 &&
    partners().length === 0
  ) {
    <div class="empty-state">
      <mat-icon>info</mat-icon>
      <span>No identities available</span>
    </div>
  }
</mat-menu>
