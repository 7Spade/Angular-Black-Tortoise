<button mat-button [matMenuTriggerFor]="identityMenu" class="identity-switcher-button">
  <mat-icon>person</mat-icon>
  <span class="identity-label">{{ getActiveIdentityDisplay() }}</span>
  <mat-icon>arrow_drop_down</mat-icon>
</button>

<mat-menu #identityMenu="matMenu" class="identity-menu">
  <!-- Personal User Identity -->
  @if (identityStore.users().length > 0) {
    <div class="menu-section">
      <div class="menu-section-header">Personal</div>
      @for (user of identityStore.users(); track user.id) {
        <button
          mat-menu-item
          (click)="onSelectIdentity('user', user.id)"
          [class.active]="
            identityStore.activeWorkspaceOwner()?.ownerId === user.id &&
            identityStore.activeWorkspaceOwner()?.ownerType === 'user'
          ">
          <mat-icon>person</mat-icon>
          <span>Personal Account</span>
          @if (
            identityStore.activeWorkspaceOwner()?.ownerId === user.id &&
            identityStore.activeWorkspaceOwner()?.ownerType === 'user'
          ) {
            <mat-icon class="check-icon">check</mat-icon>
          }
        </button>
      }
    </div>
    <mat-divider></mat-divider>
  }

  <!-- Organizations -->
  @if (identityStore.organizations().length > 0) {
    <div class="menu-section">
      <div class="menu-section-header">Organizations</div>
      @for (org of identityStore.organizations(); track org.id) {
        <button
          mat-menu-item
          (click)="onSelectIdentity('organization', org.id)"
          [class.active]="
            identityStore.activeWorkspaceOwner()?.ownerId === org.id &&
            identityStore.activeWorkspaceOwner()?.ownerType === 'organization'
          ">
          <mat-icon>business</mat-icon>
          <span>Organization</span>
          @if (
            identityStore.activeWorkspaceOwner()?.ownerId === org.id &&
            identityStore.activeWorkspaceOwner()?.ownerType === 'organization'
          ) {
            <mat-icon class="check-icon">check</mat-icon>
          }
        </button>

        <!-- Teams under Organization (display only - not selectable as workspace owners) -->
        @if (identityStore.teams().length > 0) {
          @for (team of identityStore.teams(); track team.id) {
            @if (team.organizationId === org.id) {
              <button mat-menu-item class="sub-item" disabled>
                <mat-icon>group</mat-icon>
                <span>Team: {{ team.id }}</span>
              </button>
            }
          }
        }

        <!-- Partners under Organization (display only - not selectable as workspace owners) -->
        @if (identityStore.partners().length > 0) {
          @for (partner of identityStore.partners(); track partner.id) {
            @if (partner.organizationId === org.id) {
              <button mat-menu-item class="sub-item" disabled>
                <mat-icon>handshake</mat-icon>
                <span>Partner: {{ partner.id }}</span>
              </button>
            }
          }
        }
      }
    </div>
    <mat-divider></mat-divider>
  }

  <!-- Bots (display only - bots cannot be workspace owners in current spec) -->
  @if (identityStore.bots().length > 0) {
    <div class="menu-section">
      <div class="menu-section-header">Bots</div>
      @for (bot of identityStore.bots(); track bot.id.getValue()) {
        <button mat-menu-item disabled>
          <mat-icon>smart_toy</mat-icon>
          <span>Bot {{ bot.id.getValue() }}</span>
        </button>
      }
    </div>
  }

  <!-- Empty State -->
  @if (
    identityStore.users().length === 0 &&
    identityStore.organizations().length === 0 &&
    identityStore.bots().length === 0
  ) {
    <div class="empty-state">
      <mat-icon>person_off</mat-icon>
      <p>No identities available</p>
    </div>
  }
</mat-menu>
